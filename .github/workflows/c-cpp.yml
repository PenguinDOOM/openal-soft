name: OpenAL Soft Build Test

on: [push, pull_request]

jobs:
  build:
    name: ${{ matrix.config.name }} | ${{ matrix.config.build_type }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          -
            name: "Visual Studio 2019 64-bit"
            os: windows-latest
            extra_options: "-A x64 -D"
            qt: "Qt5Widgets_DIR:PATH=C:/Qt/5.15.0/msvc2019_64/lib/cmake/Qt5Widgets"
            qtdll: "C:\Qt\5.15.0\msvc2019_64"
            build_type: "Release"
          -
            name: "Visual Studio 2019 32-bit"
            os: windows-latest
            extra_options: "-A Win32 -D"
            qt: "Qt5Widgets_DIR:PATH=C:/Qt/5.15.0/msvc2019/lib/cmake/Qt5Widgets"
            qtdll: "C:\Qt\5.15.0\msvc2019"
            build_type: "Release"

    steps:
    - name: Checkout source code
      uses: actions/checkout@v2
      with:
        ref: master

    - name: Configure
      shell: bash
      run: |
        cmake -B .\build -G "Visual Studio 16 2019" -DALSOFT_BUILD_ROUTER=ON -DALSOFT_REQUIRE_WINMM=ON -DALSOFT_REQUIRE_DSOUND=ON -DALSOFT_REQUIRE_WASAPI=ON -DALSOFT_EMBED_HRTF_DATA=YES -DCMAKE_BUILD_TYPE:STRING=${{ matrix.config.build_type }} -DFORCE_STATIC_VCRT:BOOL=ON ${{ matrix.config.extra_options }}"${{ matrix.config.qt }}"..
    
    - name: Build
      shell: bash
      run: |
        cmake --build .\build . --config ${{ matrix.config.build_type }} --clean-first
    
    - name: Packing artifact
      shell: bash
      run: |
        cd .\Build\Release
        mkdir platforms
        cp ${{ matrix.config.qtdll }}\bin\Qt5Core.dll .\
        cp ${{ matrix.config.qtdll }}\bin\Qt5Gui.dll .\
        cp ${{ matrix.config.qtdll }}\bin\Qt5Widgets.dll .\
        cp ${{ matrix.config.qtdll }}\plugins\platforms\qwindows.dll .\platforms\
        7z a -r -ssw -mx5 -t7z ${{ matrix.config.name }}_${{ matrix.config.build_type }}.7z
        cd ..\..\

    - name: Upload artifact
      uses: actions/upload-artifact@v2
      with:
        name: Artifact
        path: .\build\Release\${{ matrix.config.name }}.7z
